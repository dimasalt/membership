
<!-- saved from url=(0056)http://alexandre-salome.fr/blog/Generate-Mails-With-Twig -->
<html class="gr__alexandre-salome_fr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
            <title>Generate mails with Twig | Alexandre Salomé</title>
    <meta name="description" content="How to generate mails using the Twig Engine. Put subject, text, and HTML in one twig template, use inheritance and translations in it, even for the subject">
    <link rel="alternate" type="application/rss+xml" title="Blog posts from the alexandre-salome.fr" href="http://feeds.feedburner.com/AlexandreSalome">
        <link href="./Generate mails with Twig _ Alexandre Salomé_files/all.css" rel="stylesheet">
            <style type="text/css"></style></head>
    <body data-gr-c-s-loaded="true" cz-shortcut-listen="true">
            
<div id="banner">
    <ul id="banner-social">
            <li>
        <a href="http://feeds.feedburner.com/AlexandreSalome" title="Blog posts from the alexandre-salome.fr">
            RSS
        </a>
    </li>

            <li>
        <a href="https://plus.google.com/100267704447443627455" title="Link to my Google Plus profile">
            Google+
        </a>
    </li>

            <li>
        <a href="http://twitter.com/alexandresalome" title="Link to my Twitter profile">
            Twitter
        </a>
    </li>

            <li>
        <a href="http://github.com/alexandresalome" title="Link to my Github profile">
            Github
        </a>
    </li>

            <li>
        <a href="http://delicious.com/wodkaist" title="Link to my Delicious profile">
            Delicious
        </a>
    </li>

            <li>
        <a href="http://lastfm.fr/user/wodkaist" title="Link to my Last.fm profile">
            last.fm
        </a>
    </li>

            </ul>
</div>
    
<div id="header-wrapper">
    <div id="header">
        <h1><a href="http://alexandre-salome.fr/">Alexandre Salomé</a></h1>
        <ul>
            <li class="blog">
                <a class="active" href="http://alexandre-salome.fr/blog"><span>Blog</span></a>
            </li>
            <li class="books">
                <a href="http://alexandre-salome.fr/books"><span>Books</span></a>
            </li>
            <li class="cv">
                <a href="http://alexandre-salome.fr/cv"><span>CV</span></a>
            </li>
            <li class="contact">
                <a href="http://alexandre-salome.fr/contact"><span>Contact</span></a>
            </li>
        </ul>
    </div>
</div>
    <div id="content-wrapper">
        <div id="content">
                <div class="page-post-view">
        
        <h1>Generate mails with Twig</h1>

        <div class="post-date">
            September 28, 2011
        </div>

        <div class="blog-post-history">
                            <a title="Sass, Compass, and Assetic in 10 minutes" class="button previous" href="http://alexandre-salome.fr/blog/Sass-Compass-Assetic-In-Ten-Minutes">&lt; Previous</a>
                                        <a title="PHP Selenium Library" class="button next" href="http://alexandre-salome.fr/blog/PHP-Selenium-Library">Next &gt;</a>
                    </div>

        <div class="rich-content">
            
<div class="document">


<p>Yesterday, I discovered a new way for generating mails with Twig, in a very
powerful way.</p>
<div class="section" id="the-problem">
<h2>The problem</h2>
<p>It started because of someone explaining me he was using something similar to
this:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c">// Subject was loaded from a yaml file</span>
<span class="nv">$subject</span> <span class="o">=</span> <span class="s1">'Welcome to newsletter, %%customer_name%%'</span><span class="p">;</span>

<span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'%%customer_name%%'</span> <span class="o">=&gt;</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span>
    <span class="s1">'%%customer_mail%%'</span> <span class="o">=&gt;</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">getMail</span><span class="p">()</span>
    <span class="c">// ...</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$values</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$subject</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>For generating the content of the mail, it was something like this:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'twig'</span><span class="p">);</span> <span class="c">// a Twig_Environment instance</span>
<span class="nv">$bodyHtml</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'mail_newsletter.html.twig'</span><span class="p">);</span>
<span class="nv">$bodyText</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'mail_newsletter.text.twig'</span><span class="p">);</span>
</pre></div>
<p>The problem with this solution is that you have two different types of
templating engine. The first one is a PHP <tt class="docutils literal">str_replace</tt> templating engine and
the second one is Twig.</p>
<p>After some searches, I finally discovered a powerful way for generating mails:</p>
</div>
<div class="section" id="the-solution">
<h2>The solution</h2>
<p>First, you need to create a template, let's assume <tt class="docutils literal">mail.twig</tt>:</p>
<div class="highlight"><pre>{% block subject 'Welcome to newsletter, ' ~ customer.getName() %}

{% block body_html %}
    This is the &lt;strong&gt;HTML body&lt;/strong&gt;.
{% endblock %}

{% block body_text %}
    This is the text body.
{% endblock %}
</pre></div>
<p>This is perfect: in one file, we have every informations for generating the
mail content.</p>
<p>Let's see now how to fetch it from Twig:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'twig'</span><span class="p">);</span> <span class="c">// Twig_Environment</span>

<span class="nv">$template</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">loadTemplate</span><span class="p">(</span><span class="s1">'mail.twig'</span><span class="p">);</span>
<span class="nv">$parameters</span>  <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'customer'</span> <span class="o">=&gt;</span> <span class="nv">$customer</span>
<span class="p">);</span>

<span class="nv">$subject</span>  <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'subject'</span><span class="p">,</span>   <span class="nv">$parameters</span><span class="p">);</span>
<span class="nv">$bodyHtml</span> <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'body_html'</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
<span class="nv">$bodyText</span> <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'body_text'</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
</pre></div>
<p>And now, you have everything for creating your mail message, created from one
file only.</p>
<p>This also means you can use in your template every Twig possibilities, like the
translation extension, or the inheritance mechanism of templates.</p>
</div>
<div class="section" id="integration-in-your-application">
<h2>Integration in your application</h2>
<p>Now, we have a raw PHP implementation, let's see how it's possible to integrate
it in your application.</p>
<p>The idea is to create a class for preparing the Swift message, so in the end we
only need to set the receiver, and that's all!</p>
<p>A mail generator :</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TwigMailGenerator</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$twig</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">Twig_Environment</span> <span class="nv">$twig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span> <span class="o">=</span> <span class="nv">$twig</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">(</span><span class="nv">$identifier</span><span class="p">,</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="nv">$template</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">loadTemplate</span><span class="p">(</span><span class="s1">'mail/'</span><span class="o">.</span><span class="nv">$identifier</span><span class="o">.</span><span class="s1">'.twig'</span><span class="p">);</span> <span class="c">// Define your own schema</span>

        <span class="nv">$subject</span>  <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'subject'</span><span class="p">,</span>   <span class="nv">$parameters</span><span class="p">);</span>
        <span class="nv">$bodyHtml</span> <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'body_html'</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
        <span class="nv">$bodyText</span> <span class="o">=</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">renderBlock</span><span class="p">(</span><span class="s1">'body_text'</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">Swift_Message</span><span class="o">::</span><span class="na">newInstance</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">setSubject</span><span class="p">(</span><span class="nv">$subject</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setBody</span><span class="p">(</span><span class="nv">$bodyText</span><span class="p">,</span> <span class="s1">'text/plain'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">addPart</span><span class="p">(</span><span class="nv">$bodyHtml</span><span class="p">,</span> <span class="s1">'text/html'</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>For using it, very simple: suppose you have organized your mails according to
the schema <tt class="docutils literal"><span class="pre">mail/&lt;identifier&gt;.twig</span></tt>, the code to use it would be:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'twig'</span><span class="p">);</span>     <span class="c">// Twig_Environment</span>
<span class="nv">$mailer</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'mailer'</span><span class="p">);</span> <span class="c">// Swift_Mailer</span>

<span class="nv">$generator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TwigMailGenerator</span><span class="p">(</span><span class="nv">$twig</span><span class="p">);</span> <span class="c">// Can be in a DIC</span>

<span class="nv">$message</span> <span class="o">=</span> <span class="nv">$generator</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(</span><span class="s1">'newsletter'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'customer'</span> <span class="o">=&gt;</span> <span class="nv">$customer</span>
<span class="p">));</span>

<span class="nv">$message</span><span class="o">-&gt;</span><span class="na">setTo</span><span class="p">(</span><span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">getMail</span><span class="p">());</span>
<span class="nv">$mailer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
</pre></div>
<p>That's all for the suggested implementation! No need to create a dedicated
bundle for it, or some kind of reusable code. There are 20 lines of code, just
integrate it in your application to fit your needs, and it's enough.</p>
<p>Enjoy Twig!</p>
</div>
</div>

        </div>

         <div class="blog-post-comments">
                           <div class="comment">
        <p class="author">
                Peter
                <em>
            September 30, 2011
        </em>
    </p>
    <p class="body"></p><p>This is good, however what would you do when the email text (subject, body) come from the database? Would you generate a 'virtual' twig template and use its placeholder replacement system?
<br>
<br>Most of our clients want to edit their emails; currently I have an arcane class-based system which lacks flexibility but validates every message they compose against its allowed placeholders. Can't wait to replace it with something as user-friendly but distinctly better architected :)</p><p></p>
</div>
                            <div class="comment">
        <p class="author">
                Henrik
                <em>
            September 30, 2011
        </em>
    </p>
    <p class="body"></p><p>This does not allow you to extend and have a parent template like base.html.twig which enables a layout.</p><p></p>
</div>
                            <div class="comment">
        <p class="author">
                    <a href="http://alexandre-salome.fr/" rel="nofollow">
                Alexandre Salomé
                    </a>
                <em>
            September 30, 2011
        </em>
    </p>
    <p class="body"></p><p>@Henrik : It works : I bootstraped a quick-test with Silex : <a href="https://github.com/alexandresalome/Generate-Mails-With-Twig">https://github.com/alexandresalome/Generate-Mails-With-Twig</a></p><p></p>
</div>
                            <div class="comment">
        <p class="author">
                    <a href="http://alexandre-salome.fr/" rel="nofollow">
                Alexandre Salomé
                    </a>
                <em>
            September 30, 2011
        </em>
    </p>
    <p class="body"></p><p>@Peter : Depends of the functionalities you want to provide. If your customer can accept the Twig templating format, a templating-db-loader will be the solution.
<br>
<br>Otherwise, composition could be a solution : the customer fills 3 fields : subject, text, HTML. You only allow him to use {{ var }} syntax (no {% block %}) to avoid confusion. Then your DB loader will assemble the 3 fields.</p><p></p>
</div>
                            <div class="comment">
        <p class="author">
                Elliot Anderson
                <em>
            October 1, 2011
        </em>
    </p>
    <p class="body"></p><p>You have a trailing semicolon on your return Swift_Message::newInstance(); that might throw some people off.</p><p></p>
</div>
                            <div class="comment">
        <p class="author">
                    <a href="http://www.jdidier.net/" rel="nofollow">
                Julien DIDIER
                    </a>
                <em>
            November 14, 2011
        </em>
    </p>
    <p class="body"></p><p>Be aware that if you are using Symfony2, Twig doesn't work with templates named "template.twig".
<br>You have to define a pre-extension, like "template.mail.twig" (for this case of mails).
<br>Otherwise Twig will tell you he can't find your template.</p><p></p>
</div>
                     </div>

            </div>
        </div>
    </div>
    <div id="footer">
    <p>
      2011
      -
      Powered by
        <a href="http://symfony.com/">Symfony2</a>,
        <a href="http://www.doctrine-project.org/">Doctrine2</a>,
        <a href="https://github.com/kriswallsmith/assetic">Assetic</a>
        and coffee.
      Sourcecode available on <a href="http://github.com/alexandresalome/Alom">Github</a>.
    </p>
</div>
        <script type="text/javascript" src="./Generate mails with Twig _ Alexandre Salomé_files/all.js"></script>
        <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./Generate mails with Twig _ Alexandre Salomé_files/ga.js" type="text/javascript"></script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-1594084-3");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
            

</body></html>